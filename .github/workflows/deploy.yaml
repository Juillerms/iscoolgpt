name: Deploy to Production

on:
  workflow_run:
    workflows: ["Build Docker Images"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to AWS EC2 (Production)
    runs-on: ubuntu-latest
    

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Create .env file
      run: |
        cat > .env << EOF
        DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
        IMAGE_TAG=main
        GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
        EOF

    - name: Copy files to EC2
      run: |
        scp -i ~/.ssh/deploy_key docker-compose.prod.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/docker-compose.yml
        scp -i ~/.ssh/deploy_key .env ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/.env

    - name: Deploy on EC2
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          echo "Pulling latest images..."
          sudo docker compose pull
          
          echo "Stopping old containers..."
          sudo docker compose down
          
          echo "Starting new containers..."
          sudo docker compose up -d
          
          echo "Cleaning up old images..."
          sudo docker image prune -af
          
          echo "Checking status..."
          sudo docker compose ps
        EOF

    - name: Create Release Tag
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        TAG_NAME="v$(date +'%Y.%m.%d')-${{ github.run_number }}"
        git tag $TAG_NAME
        git push origin $TAG_NAME

    - name: Verify deployment
      run: |
        echo "âœ… Deployment to production completed successfully!"
        echo "Server: ${{ secrets.EC2_HOST }}"
        echo "Backend: http://${{ secrets.EC2_HOST }}:8000"
        echo "Environment: AWS EC2 Production"